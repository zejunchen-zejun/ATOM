name: Nightly Docker Release

on:
  schedule:
    - cron: '0 1 * * *'  # Every day at 09:00 Beijing Time (UTC+8)
  workflow_dispatch:

jobs:
  docker-release:
    name: Nightly Docker Release
    runs-on: atom-mi355-1gpu
    strategy:
      fail-fast: false
      matrix:
        baes_image:
          - "rocm/pytorch:latest"
          - "rocm/pytorch-private:ROCm_7.2_atom_1216"
        gpu_arch:
          - "gfx942"
          - "gfx950"

    steps:
      - name: Checkout ATOM repo
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        run: |
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        timeout-minutes: 120
        run: |
          docker build --network=host -t atom_release:ci --build-arg BASE_IMAGE=${{ matrix.baes_image }} --build-arg GPU_ARCH=${{ matrix.gpu_arch }} --build-arg MAX_JOBS=64 -f docker/Dockerfile .
          docker inspect atom_release:ci

      - name: Test Docker image
        timeout-minutes: 60
        if: ${{ matrix.gpu_arch == 'gfx950' }}
        run: |
          echo "Clean up containers..."
          docker ps -aq -f name=atom_release_ci | xargs -r docker stop | xargs -r docker rm
              
          if [ -f "/etc/podinfo/gha-render-devices" ]; then
            DEVICE_FLAG=$(cat /etc/podinfo/gha-render-devices)
          else
            DEVICE_FLAG="--device /dev/dri"
          fi
              
          echo "Starting container: atom_release_ci (image: atom_release:ci)"
          docker run -dt --device=/dev/kfd $DEVICE_FLAG \
            -v "${GITHUB_WORKSPACE:-$PWD}":/workspace \
            --ipc=host --group-add video \
            --shm-size 16g \
            --cap-add=SYS_PTRACE \
            -e HF_TOKEN="${HF_TOKEN:-}" \
            --security-opt seccomp=unconfined \
            --ulimit memlock=-1 \
            --ulimit stack=67108864 \
            --name atom_release_ci \
            atom_release:ci
              
          docker exec atom_release_ci bash -c \
            "python3 -m atom.examples.simple_inference \
               --model meta-llama/Meta-Llama-3-8B-Instruct \
               --temperature 0 | grep -E '^Prompt: |^Completion:'" > atom_release_output.txt
          
          echo ""
          echo "========== Showing release output below =========="
          cat atom_release_output.txt

          echo ""
          echo "========== Comparing output with golden outputs =========="
          # Ignore whitespace and EOL differences in the diff
          diff -u -B -w --strip-trailing-cr atom_release_output.txt .github/workflows/golden_outputs.txt || true
          DIFF_EXIT_CODE=$?
          
          if [ $DIFF_EXIT_CODE -ne 0 ]; then
            echo "Output does not match golden outputs."
            exit 1
          else
            echo "Output matches golden outputs."
          fi

      - name: Push Docker image
        run: |
          # Push both the versioned tag and update the 'latest' tag for the Docker image
          if [[ ${{ matrix.baes_image }} == *ROCm_7.2* ]]; then
            TAG=nightly_rocm_7.2_preview_${{ matrix.gpu_arch }}_$(date +%Y%m%d%H%M)
            docker tag atom_release:ci rocm/atom:rocm_7.2_preview_${{ matrix.gpu_arch }}_latest
            docker push rocm/atom:rocm_7.2_preview_${{ matrix.gpu_arch }}_latest
          else
            TAG=nightly_${{ matrix.gpu_arch }}_$(date +%Y%m%d%H%M)
            docker tag atom_release:ci rocm/atom:${{ matrix.gpu_arch }}_latest
            docker push rocm/atom:${{ matrix.gpu_arch }}_latest
          fi
          docker tag atom_release:ci rocm/atom:${TAG}
          docker push rocm/atom:${TAG}

      - name: Clean Up
        if: always()
        run: |
          docker stop atom_release || true
          docker rm atom_release || true
